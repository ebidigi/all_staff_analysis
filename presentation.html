<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>プレゼンモード | DigiMan</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-blue: #1155cc;
            --primary-cyan: #00a2da;
            --primary-red: #e04f24;
            --gray-50: #fafaff;
            --gray-100: #f9f9fc;
            --gray-200: #e4e8ef;
            --gray-300: #d0d4dc;
            --gray-500: #787b7f;
            --gray-600: #434547;
            --text-dark: #434547;
            --text-light: #787b7f;
            --bg-white: #FFFFFF;
            --bg-light: #f9f9fc;
            --border-color: #e4e8ef;
            --success-green: #22c55e;
            --danger-red: #e04f24;
        }

        body {
            font-family: 'Noto Sans JP', 'Poppins', sans-serif;
            background: var(--bg-white);
            min-height: 100vh;
            color: var(--text-dark);
            font-size: 14px;
            line-height: 1.6;
        }

        /* ヘッダー */
        .header {
            background: var(--bg-white);
            border-bottom: 1px solid var(--border-color);
            padding: 12px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo svg {
            width: 32px;
            height: 32px;
        }

        .logo-text {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            font-size: 18px;
            color: var(--primary-blue);
        }

        .mode-badge {
            background: var(--primary-blue);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .back-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: var(--gray-100);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-dark);
            text-decoration: none;
            font-size: 13px;
            transition: all 0.2s;
        }

        .back-btn:hover {
            background: var(--gray-200);
        }

        /* 設定パネル */
        .settings-panel {
            background: var(--gray-50);
            border-bottom: 1px solid var(--border-color);
            padding: 20px 30px;
            transition: all 0.3s ease;
        }

        .settings-panel.collapsed {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            border-bottom: none;
        }

        .settings-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 20px;
            background: var(--gray-100);
            border: 1px solid var(--border-color);
            border-radius: 0 0 8px 8px;
            cursor: pointer;
            font-size: 12px;
            color: var(--text-light);
            margin: 0 auto;
            position: relative;
            top: -1px;
        }

        .settings-toggle:hover {
            background: var(--gray-200);
        }

        .settings-toggle svg {
            transition: transform 0.3s;
        }

        .settings-panel.collapsed + .settings-toggle-wrapper .settings-toggle svg {
            transform: rotate(180deg);
        }

        .settings-row {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            align-items: flex-start;
        }

        .settings-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .settings-label {
            font-size: 12px;
            color: var(--text-light);
            font-weight: 500;
        }

        .settings-group select {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            min-width: 180px;
            background: white;
        }

        /* 日付範囲選択 */
        .date-range-picker {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .date-range-picker input[type="date"] {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            background: white;
            color: var(--text-dark);
            cursor: pointer;
            min-width: 140px;
        }

        .date-range-picker input[type="date"]:hover {
            border-color: var(--gray-300);
        }

        .date-range-picker input[type="date"]:focus {
            outline: none;
            border-color: var(--primary-blue);
        }

        .date-separator {
            color: var(--text-light);
            font-size: 14px;
        }

        /* 適用ボタン */
        .apply-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            background: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 8px;
        }

        .apply-btn:hover {
            background: #0d47a1;
        }

        /* 検索付きドロップダウン */
        .searchable-select {
            position: relative;
            min-width: 220px;
        }

        .searchable-select-trigger {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            min-height: 38px;
        }

        .searchable-select-trigger:hover {
            border-color: var(--gray-300);
        }

        .searchable-select-trigger svg {
            flex-shrink: 0;
            margin-left: 8px;
            transition: transform 0.2s;
        }

        .searchable-select.open .searchable-select-trigger svg {
            transform: rotate(180deg);
        }

        .searchable-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 4px;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 100;
            display: none;
            max-height: 300px;
            overflow: hidden;
        }

        .searchable-select.open .searchable-select-dropdown {
            display: block;
        }

        .searchable-select-search {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .searchable-select-search input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            outline: none;
        }

        .searchable-select-search input:focus {
            border-color: var(--primary-blue);
        }

        .searchable-select-options {
            max-height: 220px;
            overflow-y: auto;
        }

        .searchable-select-option {
            padding: 10px 14px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.15s;
        }

        .searchable-select-option:hover {
            background: var(--gray-100);
        }

        .searchable-select-option.selected {
            background: var(--primary-blue);
            color: white;
        }

        .searchable-select-option.hidden {
            display: none;
        }

        .searchable-select-empty {
            padding: 20px;
            text-align: center;
            color: var(--text-light);
            font-size: 13px;
        }

        .settings-label input[type="checkbox"] {
            margin-right: 6px;
            cursor: pointer;
        }

        .comparison-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .comparison-selector.hidden {
            display: none;
        }

        .comparison-selector span {
            color: var(--text-light);
            font-size: 14px;
        }

        .display-toggles {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .toggle-btn {
            padding: 6px 14px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            background: white;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-light);
        }

        .toggle-btn.active {
            background: var(--primary-blue);
            border-color: var(--primary-blue);
            color: white;
        }

        .toggle-btn:hover:not(.active) {
            background: var(--gray-100);
        }

        /* メインコンテンツ */
        .main-content {
            padding: 40px 60px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .project-name {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .project-name::before {
            content: '';
            display: block;
            width: 6px;
            height: 36px;
            background: var(--primary-blue);
            border-radius: 3px;
        }

        .comparison-period {
            font-size: 16px;
            color: var(--text-light);
            margin-bottom: 40px;
            margin-left: 21px;
        }

        /* KPIセクション */
        .kpi-section {
            margin-bottom: 50px;
        }

        .kpi-section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }

        .kpi-cards {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }

        .kpi-card {
            background: var(--bg-white);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 30px 40px;
            min-width: 220px;
            flex: 1;
            max-width: 300px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .kpi-label {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 10px;
        }

        .kpi-value {
            font-family: 'Poppins', sans-serif;
            font-size: 42px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 12px;
        }

        .kpi-comparison {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .kpi-diff {
            font-size: 16px;
            font-weight: 600;
        }

        .kpi-diff.positive {
            color: var(--primary-blue);
        }

        .kpi-diff.negative {
            color: var(--danger-red);
        }

        .kpi-diff.neutral {
            color: var(--text-light);
        }

        .kpi-rate {
            font-size: 14px;
            color: var(--text-light);
        }

        /* 担当者別内訳 */
        .member-breakdown {
            margin-top: 50px;
        }

        .member-toggle-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: var(--gray-100);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-dark);
            transition: all 0.2s;
        }

        .member-toggle-btn:hover {
            background: var(--gray-200);
        }

        .member-toggle-btn svg {
            transition: transform 0.3s;
        }

        .member-toggle-btn.expanded svg {
            transform: rotate(180deg);
        }

        .member-table-wrapper {
            margin-top: 20px;
            display: none;
            overflow-x: auto;
        }

        .member-table-wrapper.show {
            display: block;
        }

        .member-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .member-table th {
            background: var(--gray-100);
            padding: 14px 20px;
            text-align: left;
            font-weight: 600;
            color: var(--text-dark);
            border-bottom: 2px solid var(--border-color);
            white-space: nowrap;
        }

        .member-table td {
            padding: 14px 20px;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }

        .member-table tr:hover {
            background: var(--gray-50);
        }

        .member-table .number {
            font-family: 'Poppins', sans-serif;
            text-align: right;
        }

        .member-table .diff {
            font-size: 12px;
            margin-left: 8px;
        }

        .member-table .diff.positive {
            color: var(--primary-blue);
        }

        .member-table .diff.negative {
            color: var(--danger-red);
        }

        /* ローディング */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 80px;
            color: var(--text-light);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--primary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* 空状態 */
        .empty-state {
            text-align: center;
            padding: 80px;
            color: var(--text-light);
        }

        .empty-state svg {
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* レスポンシブ */
        @media (max-width: 1200px) {
            .main-content {
                padding: 30px 40px;
            }

            .kpi-card {
                min-width: 180px;
                padding: 24px 30px;
            }

            .kpi-value {
                font-size: 36px;
            }
        }

        @media (max-width: 768px) {
            .settings-row {
                flex-direction: column;
            }

            .kpi-cards {
                flex-direction: column;
            }

            .kpi-card {
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <!-- ヘッダー -->
    <header class="header">
        <div class="header-left">
            <div class="logo">
                <svg viewBox="0 0 40 40" fill="none">
                    <rect width="40" height="40" rx="8" fill="#1155cc"/>
                    <path d="M12 14h6v12h-6zM22 10h6v16h-6z" fill="white"/>
                </svg>
                <span class="logo-text">DigiMan</span>
            </div>
            <span class="mode-badge">プレゼンモード</span>
        </div>
        <div class="header-right">
            <a id="backToDashboard" href="index.html" class="back-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                ダッシュボードに戻る
            </a>
        </div>
    </header>

    <!-- 設定パネル -->
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-row">
            <div class="settings-group">
                <label class="settings-label">案件</label>
                <div class="searchable-select" id="projectSelectContainer">
                    <div class="searchable-select-trigger" onclick="toggleProjectDropdown()">
                        <span id="projectSelectLabel">読み込み中...</span>
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                    </div>
                    <div class="searchable-select-dropdown">
                        <div class="searchable-select-search">
                            <input type="text" id="projectSearchInput" placeholder="案件を検索..." oninput="filterProjects()">
                        </div>
                        <div class="searchable-select-options" id="projectOptions"></div>
                    </div>
                </div>
                <input type="hidden" id="projectSelect" value="">
            </div>

            <div class="settings-group">
                <label class="settings-label">表示期間</label>
                <div class="date-range-picker">
                    <input type="date" id="currentStartDate">
                    <span class="date-separator">〜</span>
                    <input type="date" id="currentEndDate">
                </div>
            </div>

            <div class="settings-group">
                <label class="settings-label">
                    <input type="checkbox" id="enableComparison" onchange="toggleComparisonUI()" checked>
                    期間比較
                </label>
                <div class="comparison-selector" id="comparisonSelector">
                    <span>vs</span>
                    <div class="date-range-picker">
                        <input type="date" id="prevStartDate">
                        <span class="date-separator">〜</span>
                        <input type="date" id="prevEndDate">
                    </div>
                </div>
                <button class="apply-btn" onclick="applyFilters()">適用</button>
            </div>

            <div class="settings-group">
                <label class="settings-label">表示項目</label>
                <div class="display-toggles" id="displayToggles">
                    <button class="toggle-btn active" data-metric="calls" onclick="toggleMetric(this)">架電数</button>
                    <button class="toggle-btn active" data-metric="pr" onclick="toggleMetric(this)">PR数</button>
                    <button class="toggle-btn active" data-metric="appo" onclick="toggleMetric(this)">アポ数</button>
                    <button class="toggle-btn active" data-metric="callToPR" onclick="toggleMetric(this)">架電toPR率</button>
                    <button class="toggle-btn active" data-metric="prToAppo" onclick="toggleMetric(this)">PRtoアポ率</button>
                    <button class="toggle-btn active" data-metric="callToAppo" onclick="toggleMetric(this)">架電toアポ率</button>
                </div>
            </div>
        </div>
    </div>

    <div class="settings-toggle-wrapper">
        <button class="settings-toggle" onclick="toggleSettings()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 15 12 9 18 15"/>
            </svg>
            <span id="settingsToggleText">設定を隠す</span>
        </button>
    </div>

    <!-- メインコンテンツ -->
    <main class="main-content" id="mainContent">
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <span>データを読み込んでいます...</span>
        </div>

        <div id="presentationContent" style="display: none;">
            <h1 class="project-name" id="projectName">案件名</h1>
            <p class="comparison-period" id="comparisonPeriod">2024年9月 vs 2024年8月</p>

            <!-- 実績セクション -->
            <section class="kpi-section" id="numbersSection">
                <h2 class="kpi-section-title">実績</h2>
                <div class="kpi-cards" id="numbersCards"></div>
            </section>

            <!-- 率指標セクション -->
            <section class="kpi-section" id="ratesSection">
                <h2 class="kpi-section-title">率指標</h2>
                <div class="kpi-cards" id="ratesCards"></div>
            </section>

            <!-- 担当者別内訳 -->
            <section class="member-breakdown">
                <button class="member-toggle-btn" id="memberToggleBtn" onclick="toggleMemberBreakdown()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"/>
                    </svg>
                    担当者別内訳を表示
                </button>
                <div class="member-table-wrapper" id="memberTableWrapper">
                    <table class="member-table" id="memberTable">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>
        </div>
    </main>

    <script>
        // ==================== 設定 ====================
        const TURSO_CONFIG = {
            url: 'https://all-staff-rawdata-ebidigi.aws-ap-northeast-1.turso.io',
            authToken: 'eyJhbGciOiJFZERTQSIsInR5cCI6IkpXVCJ9.eyJpYXQiOjE3NzE0NjQ3MDQsImlkIjoiNGM0YTZjMjMtYWM4Zi00NmNlLThkMGQtNzJkMTk4YjMwMzkxIiwicmlkIjoiMGNlYTQzNzgtYzk2My00MjIzLWI4MmYtMTg1MzNkZDhjYWEzIn0.H-wdaWOE_bVajLf3yc_MkoaMuTr0-4zEeXONxQZmdXm_r3aVerE55gXsINoS4vdglt8G3gzFRSl7wSHRAL9vDQ'
        };

        const TURSO_CONFIG_TALENT = {
            url: 'https://digiman-talent-ebidigi.aws-ap-northeast-1.turso.io',
            authToken: 'eyJhbGciOiJFZERTQSIsInR5cCI6IkpXVCJ9.eyJpYXQiOjE3NzE0Njk4NDAsImlkIjoiODQ1ODVmNTUtZmIzZS00ZGNlLWExNWItOTIxMmRkNWRkMGM5IiwicmlkIjoiOWM2M2U4NmItZjk5Ny00YmFjLWIxMzctOTc3YWQwYzQ0NWZkIn0.3zDDfpaWtnje4hUS-mhte6USz4aU_Wl4CyKh3DlWHCh4-slVTFiDlCICb975mN4bdyHjxuVNgchLW0VBXhEsBg'
        };

        const EXCLUDED_MEMBERS = ['@山田　香苗', '@須藤　明里/akari sudo'];

        // ==================== 状態管理 ====================
        let allRecords = [];
        let employeeMaster = {};
        let selectedMetrics = ['calls', 'pr', 'appo', 'callToPR', 'prToAppo', 'callToAppo'];

        const metricConfig = {
            calls: { label: '架電数', unit: '件', type: 'number' },
            pr: { label: 'PR数', unit: '件', type: 'number' },
            appo: { label: 'アポ数', unit: '件', type: 'number' },
            callToPR: { label: '架電toPR率', unit: '%', type: 'rate' },
            prToAppo: { label: 'PRtoアポ率', unit: '%', type: 'rate' },
            callToAppo: { label: '架電toアポ率', unit: '%', type: 'rate' }
        };

        // ==================== 初期化 ====================
        document.addEventListener('DOMContentLoaded', async function() {
            // 環境に応じてリンクを設定
            setupNavigationLinks();

            await loadEmployeeMaster();
            await loadAllRecords();
            initSelectors();
            updateDisplay();
        });

        function setupNavigationLinks() {
            const currentPath = window.location.pathname;
            const isLocalDeploy = currentPath.includes('all_staff_');

            const backLink = document.getElementById('backToDashboard');
            if (backLink) {
                backLink.href = isLocalDeploy ? 'all_staff_analysis.html' : 'index.html';
            }
        }

        // ==================== データ取得 ====================
        async function executeTursoQuery(url, authToken, sql) {
            const httpUrl = url + '/v3/pipeline';
            const payload = {
                requests: [
                    { type: 'execute', stmt: { sql: sql } },
                    { type: 'close' }
                ]
            };

            const response = await fetch(httpUrl, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            if (result.results && result.results[0] && result.results[0].response) {
                return result.results[0].response.result;
            }
            return null;
        }

        async function loadEmployeeMaster() {
            try {
                const result = await executeTursoQuery(
                    TURSO_CONFIG_TALENT.url,
                    TURSO_CONFIG_TALENT.authToken,
                    "SELECT name, employee_type FROM employees WHERE retire_date IS NULL OR retire_date > date('now')"
                );
                if (result && result.rows) {
                    result.rows.forEach(row => {
                        const name = row[0]?.value;
                        const type = row[1]?.value || 'employee';
                        if (name) employeeMaster[name] = type;
                    });
                }
            } catch (e) {
                console.error('Failed to load employee master:', e);
            }
        }

        async function loadAllRecords() {
            try {
                const result = await executeTursoQuery(
                    TURSO_CONFIG.url,
                    TURSO_CONFIG.authToken,
                    "SELECT member_name, project_name, input_date, call_hours, call_count, pr_count, appointment_count FROM performance_rawdata WHERE data_source = 'new' ORDER BY input_date DESC"
                );

                if (result && result.rows) {
                    allRecords = result.rows.map(row => ({
                        name: row[0]?.value || '',
                        project: row[1]?.value || '',
                        date: row[2]?.value || '',
                        callTime: parseFloat(row[3]?.value) || 0,
                        calls: parseInt(row[4]?.value) || 0,
                        pr: parseInt(row[5]?.value) || 0,
                        appo: parseInt(row[6]?.value) || 0
                    })).filter(r => !EXCLUDED_MEMBERS.includes(r.name));
                }

                document.getElementById('loading').style.display = 'none';
                document.getElementById('presentationContent').style.display = 'block';
            } catch (e) {
                console.error('Failed to load records:', e);
                document.getElementById('loading').innerHTML = '<span>データの読み込みに失敗しました</span>';
            }
        }

        // ==================== セレクター初期化 ====================
        function initSelectors() {
            // 案件一覧（検索付きドロップダウン）
            const projects = [...new Set(allRecords.map(r => r.project))].filter(p => p).sort();
            const optionsContainer = document.getElementById('projectOptions');

            let optionsHtml = `<div class="searchable-select-option selected" data-value="" onclick="selectProject('')">全案件</div>`;
            optionsHtml += projects.map(p =>
                `<div class="searchable-select-option" data-value="${p}" onclick="selectProject('${p.replace(/'/g, "\\'")}')">${p}</div>`
            ).join('');
            optionsContainer.innerHTML = optionsHtml;

            document.getElementById('projectSelectLabel').textContent = '全案件';
            document.getElementById('projectSelect').value = '';

            // 日付範囲の初期値を設定
            initDateRanges();

            // ドロップダウン外クリックで閉じる
            document.addEventListener('click', function(e) {
                const dropdowns = ['projectSelectContainer'];
                dropdowns.forEach(id => {
                    const container = document.getElementById(id);
                    if (container && !container.contains(e.target)) {
                        container.classList.remove('open');
                    }
                });
            });
        }

        function initDateRanges() {
            // データから日付範囲を取得
            const dates = allRecords.map(r => r.date).filter(d => d).sort();
            if (dates.length === 0) return;

            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth();

            // 表示期間: 今月の初日〜今日
            const currentMonthStart = new Date(currentYear, currentMonth, 1);
            const currentMonthEnd = today;

            // 比較期間: 前月の同期間
            const prevMonthStart = new Date(currentYear, currentMonth - 1, 1);
            const prevMonthEnd = new Date(currentYear, currentMonth - 1, today.getDate());

            // 前月の末日を超えないように調整
            const lastDayOfPrevMonth = new Date(currentYear, currentMonth, 0).getDate();
            if (prevMonthEnd.getDate() > lastDayOfPrevMonth) {
                prevMonthEnd.setDate(lastDayOfPrevMonth);
            }

            // 入力フィールドに設定
            document.getElementById('currentStartDate').value = formatDateForInput(currentMonthStart);
            document.getElementById('currentEndDate').value = formatDateForInput(currentMonthEnd);
            document.getElementById('prevStartDate').value = formatDateForInput(prevMonthStart);
            document.getElementById('prevEndDate').value = formatDateForInput(prevMonthEnd);

            // データ範囲でmin/maxを設定
            const minDate = dates[0];
            const maxDate = dates[dates.length - 1];
            ['currentStartDate', 'currentEndDate', 'prevStartDate', 'prevEndDate'].forEach(id => {
                const input = document.getElementById(id);
                input.min = minDate;
                input.max = maxDate;
            });
        }

        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDateForDisplay(dateStr) {
            if (!dateStr) return '';
            const [year, month, day] = dateStr.split('-');
            return `${year}年${parseInt(month)}月${parseInt(day)}日`;
        }

        // ==================== 表示更新 ====================
        function updateDisplay() {
            const project = document.getElementById('projectSelect').value;
            const currentStart = document.getElementById('currentStartDate').value;
            const currentEnd = document.getElementById('currentEndDate').value;
            const prevStart = document.getElementById('prevStartDate').value;
            const prevEnd = document.getElementById('prevEndDate').value;
            const comparisonEnabled = isComparisonEnabled();

            // プロジェクト名
            document.getElementById('projectName').textContent = project || '全案件';

            // 表示期間
            const currentLabel = formatPeriodLabel(currentStart, currentEnd);
            const prevLabel = formatPeriodLabel(prevStart, prevEnd);
            if (comparisonEnabled) {
                document.getElementById('comparisonPeriod').textContent = `${currentLabel} vs ${prevLabel}`;
            } else {
                document.getElementById('comparisonPeriod').textContent = currentLabel;
            }

            // データ集計
            const currentData = aggregateData(filterByDateRangeAndProject(currentStart, currentEnd, project));
            const prevData = comparisonEnabled ? aggregateData(filterByDateRangeAndProject(prevStart, prevEnd, project)) : null;

            // 実績カード
            renderNumberCards(currentData, prevData, comparisonEnabled);

            // 率指標カード
            renderRateCards(currentData, prevData, comparisonEnabled);

            // 担当者別テーブル
            renderMemberTableWithDateRange(currentStart, currentEnd, prevStart, prevEnd, project, comparisonEnabled);

            // セクション表示制御
            const hasNumbers = selectedMetrics.some(m => ['calls', 'pr', 'appo'].includes(m));
            const hasRates = selectedMetrics.some(m => ['callToPR', 'prToAppo', 'callToAppo'].includes(m));
            document.getElementById('numbersSection').style.display = hasNumbers ? 'block' : 'none';
            document.getElementById('ratesSection').style.display = hasRates ? 'block' : 'none';
        }

        function formatPeriodLabel(startDate, endDate) {
            if (!startDate || !endDate) return '';
            const start = formatDateForDisplay(startDate);
            const end = formatDateForDisplay(endDate);
            // 同じ月なら省略形で表示
            if (startDate.substring(0, 7) === endDate.substring(0, 7)) {
                const [year, month] = startDate.split('-');
                const startDay = parseInt(startDate.split('-')[2]);
                const endDay = parseInt(endDate.split('-')[2]);
                return `${year}年${parseInt(month)}月${startDay}日〜${endDay}日`;
            }
            return `${start}〜${end}`;
        }

        function filterByDateRangeAndProject(startDate, endDate, project) {
            return allRecords.filter(r => {
                const matchDate = r.date && r.date >= startDate && r.date <= endDate;
                const matchProject = !project || r.project === project;
                return matchDate && matchProject;
            });
        }

        function aggregateData(records) {
            const totals = {
                calls: 0,
                pr: 0,
                appo: 0,
                callTime: 0
            };

            records.forEach(r => {
                totals.calls += r.calls;
                totals.pr += r.pr;
                totals.appo += r.appo;
                totals.callTime += r.callTime;
            });

            // 率計算
            totals.callToPR = totals.calls > 0 ? (totals.pr / totals.calls * 100) : 0;
            totals.prToAppo = totals.pr > 0 ? (totals.appo / totals.pr * 100) : 0;
            totals.callToAppo = totals.calls > 0 ? (totals.appo / totals.calls * 100) : 0;

            return totals;
        }

        // ==================== カード描画 ====================
        function renderNumberCards(current, prev, comparisonEnabled) {
            const container = document.getElementById('numbersCards');
            const metrics = ['calls', 'pr', 'appo'].filter(m => selectedMetrics.includes(m));

            container.innerHTML = metrics.map(metric => {
                const config = metricConfig[metric];
                const value = current[metric];
                const prevValue = prev ? prev[metric] : 0;
                const diff = value - prevValue;
                const rate = prevValue > 0 ? ((diff / prevValue) * 100) : 0;

                return createKpiCard(config.label, value, config.unit, diff, rate, 'number', comparisonEnabled);
            }).join('');
        }

        function renderRateCards(current, prev, comparisonEnabled) {
            const container = document.getElementById('ratesCards');
            const metrics = ['callToPR', 'prToAppo', 'callToAppo'].filter(m => selectedMetrics.includes(m));

            container.innerHTML = metrics.map(metric => {
                const config = metricConfig[metric];
                const value = current[metric];
                const prevValue = prev ? prev[metric] : 0;
                const diff = value - prevValue; // ポイント差

                return createKpiCard(config.label, value.toFixed(1), config.unit, diff, null, 'rate', comparisonEnabled);
            }).join('');
        }

        function createKpiCard(label, value, unit, diff, rate, type, comparisonEnabled) {
            const diffClass = diff > 0 ? 'positive' : diff < 0 ? 'negative' : 'neutral';
            const diffSign = diff > 0 ? '+' : '';

            let diffText = '';
            if (type === 'number') {
                diffText = `${diffSign}${diff.toLocaleString()}${unit}`;
            } else {
                diffText = `${diffSign}${diff.toFixed(1)}pt`;
            }

            let rateText = '';
            if (rate !== null) {
                const rateSign = rate > 0 ? '+' : '';
                rateText = `<span class="kpi-rate">(${rateSign}${rate.toFixed(1)}%)</span>`;
            }

            // 比較が無効の場合は比較部分を非表示
            const comparisonHtml = comparisonEnabled ? `
                    <div class="kpi-comparison">
                        <span class="kpi-diff ${diffClass}">${diffText}</span>
                        ${rateText}
                    </div>
            ` : '';

            return `
                <div class="kpi-card">
                    <div class="kpi-label">${label}</div>
                    <div class="kpi-value">${typeof value === 'number' ? value.toLocaleString() : value}${unit === '%' ? '%' : ''}</div>
                    ${comparisonHtml}
                </div>
            `;
        }

        // ==================== 担当者別テーブル ====================
        function renderMemberTableWithDateRange(currentStart, currentEnd, prevStart, prevEnd, project, comparisonEnabled) {
            const currentRecords = filterByDateRangeAndProject(currentStart, currentEnd, project);
            const prevRecords = comparisonEnabled ? filterByDateRangeAndProject(prevStart, prevEnd, project) : [];

            // 担当者別に集計
            const memberMap = {};
            currentRecords.forEach(r => {
                if (!memberMap[r.name]) {
                    memberMap[r.name] = { current: { calls: 0, pr: 0, appo: 0 }, prev: { calls: 0, pr: 0, appo: 0 } };
                }
                memberMap[r.name].current.calls += r.calls;
                memberMap[r.name].current.pr += r.pr;
                memberMap[r.name].current.appo += r.appo;
            });

            prevRecords.forEach(r => {
                if (!memberMap[r.name]) {
                    memberMap[r.name] = { current: { calls: 0, pr: 0, appo: 0 }, prev: { calls: 0, pr: 0, appo: 0 } };
                }
                memberMap[r.name].prev.calls += r.calls;
                memberMap[r.name].prev.pr += r.pr;
                memberMap[r.name].prev.appo += r.appo;
            });

            // テーブル描画
            const table = document.getElementById('memberTable');
            const visibleMetrics = selectedMetrics.filter(m => ['calls', 'pr', 'appo'].includes(m));

            // ヘッダー
            let headerHtml = '<tr><th>担当者</th>';
            visibleMetrics.forEach(m => {
                headerHtml += `<th>${metricConfig[m].label}</th>`;
            });
            if (selectedMetrics.includes('callToPR')) headerHtml += '<th>架電toPR率</th>';
            headerHtml += '</tr>';
            table.querySelector('thead').innerHTML = headerHtml;

            // ボディ
            const members = Object.keys(memberMap).sort((a, b) => {
                return memberMap[b].current.calls - memberMap[a].current.calls;
            });

            let bodyHtml = '';
            members.forEach(name => {
                const data = memberMap[name];
                const rate = data.current.calls > 0 ? (data.current.pr / data.current.calls * 100).toFixed(1) : '0.0';

                bodyHtml += `<tr><td>${name}</td>`;
                visibleMetrics.forEach(m => {
                    const val = data.current[m];
                    if (comparisonEnabled) {
                        const prev = data.prev[m];
                        const diff = val - prev;
                        const diffClass = diff > 0 ? 'positive' : diff < 0 ? 'negative' : '';
                        const diffSign = diff > 0 ? '+' : '';
                        bodyHtml += `<td class="number">${val.toLocaleString()}<span class="diff ${diffClass}">${diffSign}${diff}</span></td>`;
                    } else {
                        bodyHtml += `<td class="number">${val.toLocaleString()}</td>`;
                    }
                });
                if (selectedMetrics.includes('callToPR')) {
                    bodyHtml += `<td class="number">${rate}%</td>`;
                }
                bodyHtml += '</tr>';
            });
            table.querySelector('tbody').innerHTML = bodyHtml;
        }

        // ==================== UI操作 ====================
        function toggleProjectDropdown() {
            const container = document.getElementById('projectSelectContainer');
            container.classList.toggle('open');
            if (container.classList.contains('open')) {
                document.getElementById('projectSearchInput').focus();
            }
        }

        function filterProjects() {
            const searchText = document.getElementById('projectSearchInput').value.toLowerCase();
            const options = document.querySelectorAll('#projectOptions .searchable-select-option');

            let visibleCount = 0;
            options.forEach(option => {
                const text = option.textContent.toLowerCase();
                const matches = text.includes(searchText);
                option.classList.toggle('hidden', !matches);
                if (matches) visibleCount++;
            });

            // 検索結果がない場合のメッセージ
            let emptyMsg = document.querySelector('.searchable-select-empty');
            if (visibleCount === 0) {
                if (!emptyMsg) {
                    emptyMsg = document.createElement('div');
                    emptyMsg.className = 'searchable-select-empty';
                    emptyMsg.textContent = '該当する案件がありません';
                    document.getElementById('projectOptions').appendChild(emptyMsg);
                }
                emptyMsg.style.display = 'block';
            } else if (emptyMsg) {
                emptyMsg.style.display = 'none';
            }
        }

        function selectProject(value) {
            const options = document.querySelectorAll('#projectOptions .searchable-select-option');
            options.forEach(option => {
                option.classList.toggle('selected', option.dataset.value === value);
            });

            document.getElementById('projectSelect').value = value;
            document.getElementById('projectSelectLabel').textContent = value || '全案件';
            document.getElementById('projectSelectContainer').classList.remove('open');
            document.getElementById('projectSearchInput').value = '';
            filterProjects(); // リセット
            // 適用ボタンで反映するため、ここでは updateDisplay() を呼ばない
        }

        function applyFilters() {
            updateDisplay();
        }

        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            const text = document.getElementById('settingsToggleText');
            panel.classList.toggle('collapsed');
            text.textContent = panel.classList.contains('collapsed') ? '設定を表示' : '設定を隠す';
        }

        function toggleComparisonUI() {
            const checkbox = document.getElementById('enableComparison');
            const selector = document.getElementById('comparisonSelector');
            if (checkbox.checked) {
                selector.classList.remove('hidden');
            } else {
                selector.classList.add('hidden');
            }
            // 適用ボタンで反映するため、ここでは updateDisplay() を呼ばない
        }

        function isComparisonEnabled() {
            return document.getElementById('enableComparison').checked;
        }

        function toggleMetric(btn) {
            const metric = btn.dataset.metric;
            btn.classList.toggle('active');

            if (btn.classList.contains('active')) {
                if (!selectedMetrics.includes(metric)) {
                    selectedMetrics.push(metric);
                }
            } else {
                selectedMetrics = selectedMetrics.filter(m => m !== metric);
            }

            updateDisplay();
        }

        function toggleMemberBreakdown() {
            const btn = document.getElementById('memberToggleBtn');
            const wrapper = document.getElementById('memberTableWrapper');
            btn.classList.toggle('expanded');
            wrapper.classList.toggle('show');
            btn.querySelector('span') || (btn.innerHTML = btn.innerHTML.replace('表示', wrapper.classList.contains('show') ? '非表示' : '表示'));
        }
    </script>
</body>
</html>
